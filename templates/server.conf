{#
# Copyright (C) 2017  Ghent University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}
# OpenVPN server configuration file generated by easy-openvpn-server
mode server
client-config-dir {{config_dir}}/client-configs
ca                {{config_dir}}/ca.crt
cert              {{config_dir}}/server.crt
key               {{config_dir}}/server.key
dh                {{dh}}
crl-verify        {{config_dir}}/crl.pem

# Authenticate the TLS channel with a PSK that is shared among all peers.
#  This is mostly to protect from DOS attacks. Traffic on the TLS channel
#  has a high crypto/cpu load. An attacker might send garbage traffic on this
#  channel to overload the cpu of the server. The PSK enables the server to
#  drop garbage traffic before doing crypto, this makes it hard to overload
#  the cpu by sending garbage traffic on the TLS channel. Note that this only
#  works against attackers that don't have the PSK, won't protect you from
#  an angry ex-employee.
tls-auth {{config_dir}}/ta.key
key-direction 0

status {{status_file_path}}
status-version 2

# After startup of the OpenVPN server, drop privileges to the `snap_daemon`
# user and group. This increases the security because it lowers the amount of
# damage a compromised OpenVPN server can do.
#
# Currently, only the `snap_daemon` user is supported by snapd.
# More info: https://snapcraft.io/docs/system-usernames
user snap_daemon
group snap_daemon

# OpenVPN traffic on 443/tcp is almost never blocked because, since OpenVPN
# uses SSL, it's very hard to distinguish this traffic from "real" HTTPS
# traffic.
#
# Using udp as protocol is faster but many firewalls block it.
proto {{protocol}}
port {{port}}
# Use TLS for encryption
tls-server
# TLS versions <1.2 are vulnerable to many attacks.
tls-version-min 1.2
# Prefer the strong AES-256-GCM cipher but also allow slightly weaker ciphers
# to have more compatibility. (Although those ciphers are still very secure.)
#
# More info:
# - https://community.openvpn.net/openvpn/wiki/DeprecatedOptions#Policy:Migratingawayfromdeprecatedciphers
# - https://openvpn.net/vpn-server-resources/faq-regarding-openvpn-connect-android/
# - https://www.privateinternetaccess.com/helpdesk/kb/articles/what-s-the-difference-between-aes-cbc-and-aes-gcm
# - https://fedoraproject.org/wiki/Changes/New_default_cipher_in_OpenVPN
cipher AES-256-GCM
ncp-ciphers AES-256-GCM:AES-256-CBC:AES-128-GCM
# Use SHA256 for auth since the default SHA1 is insecure. This setting will
# be ignored when GCM is used (which uses SHA384)
auth SHA256

# Compress packets with lzo. lz4 is more efficient, but it's not compatible
# with OpenVPN versions <2.4.
# Disable by default to avoid Compression oracle attacks,
# see: https://superuser.com/questions/1686651/why-is-compression-not-recommended-in-openvpn
#
compress no

# tun has lower traffic overhead than tap.
dev tun
keepalive 10 60
persist-key
persist-tun

# Accept connections on all interfaces
multihome
# IPv4 network to use for the tunnel
server {{tunnel_network}} {{tunnel_netmask}}
# IPv6 network to use for the tunnel
server-ipv6 {{tunnel_network_v6}}

{% if duplicate_cn -%}
# Allow multiple simultaneous connections with the same certificate/key files.
duplicate-cn
{% endif %}

# We want to push to the clients
# - our DNS server
# - routes to the networks we know
{% if push_dns -%}
  {% for dns_server in dns_servers -%}
  push "dhcp-option DNS {{dns_server}}"
  # Make sure that clients route requests to our DNS server through us, even
  # when our DNS server isn't in one of the subnets we push.
  push "route {{dns_server}} 255.255.255.255"
  {% endfor %}
  {% for dns_search_domain in dns_search_domains -%}
  push "dhcp-option DOMAIN {{dns_search_domain}}"
  {% endfor %}
{% endif %}
# Make sure clients route requests to our subnets through us.
{% for network in internal_networks -%}
  push "route {{network.network_address}} {{network.netmask}}"
{% endfor %}
{% if push_default_gateway -%}
  # Use VPN as default gateway for IPv4 and IPv6 traffic
  push "redirect-gateway def1 bypass-dhcp"
  push "redirect-gateway ipv6"
  # Also make sure all DNS queries are sent to the DNS server of the VPN when
  # the VPN is the default gateway. NetworkManager does this automatically but
  # the `update-systemd-resolved` script used by the openvpn CLI requires this
  # option.
  # https://github.com/jonathanio/update-systemd-resolved#usage
  # https://github.com/systemd/systemd/issues/6076#issuecomment-432177655
  push "dhcp-option DOMAIN-ROUTE ."
{% endif %}

topology net30
